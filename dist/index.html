<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Observable Framework v1.13.2">
<title>Mind the gap</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air.aad62322.css">
<link rel="preload" as="style" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air.aad62322.css">
<link rel="stylesheet" type="text/css" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="modulepreload" href="./_observablehq/client.1f32af9d.js">
<link rel="modulepreload" href="./_observablehq/runtime.9393ab6d.js">
<link rel="modulepreload" href="./_observablehq/stdlib.d4a7cb81.js">
<link rel="modulepreload" href="./_npm/arquero@7.2.0/f3eb4e3f.js">
<link rel="modulepreload" href="./_npm/@shoelace-style/shoelace@2.19.0/41f6f18a.js">
<link rel="modulepreload" href="./_npm/showdown@2.1.0/ed1696ce.js">
<link rel="modulepreload" href="./_import/components/helpers.3bac2dd4.js">
<link rel="modulepreload" href="./_npm/exceljs@4.4.0/222f7a0c.js">
<link rel="modulepreload" href="./_npm/lodash@4.17.21/cbfa4f05.js">
<link rel="modulepreload" href="./_npm/htl@0.3.1/063eb405.js">
<link rel="modulepreload" href="./_observablehq/stdlib/inputs.ff6354fc.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/407f7a1f.js">
<link rel="modulepreload" href="./_npm/isoformat@0.2.1/c68fbd73.js">
<link rel="modulepreload" href="./_npm/acorn@8.14.0/6d258ba8.js">
<link rel="modulepreload" href="./_npm/@uwdata/flechette@1.1.1/df6d503a.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/a9c7db3f.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/decorators.js.fcd1f26b.js">
<link rel="modulepreload" href="./_npm/@shoelace-style/localize@3.2.1/a12c53c5.js">
<link rel="modulepreload" href="./_npm/@floating-ui/dom@1.6.12/d5637756.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directives/class-map.js.0cfabbe4.js">
<link rel="modulepreload" href="./_npm/composed-offset-position@0.0.6/16846fbe.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directive-helpers.js.703468a9.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directives/if-defined.js.71142b33.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directives/live.js.bbe9eb7e.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directives/when.js.dfcf17d7.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/static-html.js.d4d0e1d2.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directives/unsafe-html.js.ea620375.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directives/style-map.js.18165ad5.js">
<link rel="modulepreload" href="./_npm/qr-creator@1.0.0/1bba10de.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directives/ref.js.dd968e91.js">
<link rel="modulepreload" href="./_npm/@ctrl/tinycolor@4.1.0/315b22c9.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directives/map.js.4050c59b.js">
<link rel="modulepreload" href="./_npm/lit@3.2.1/directives/range.js.56377c2f.js">
<link rel="modulepreload" href="./_npm/@shoelace-style/animations@1.2.0/be6e08f6.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/35654262.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/02f42605.js">
<link rel="modulepreload" href="./_npm/lit-element@4.1.1/lit-element.js.0f45aa27.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/is-server.js.d63f4955.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/decorators/custom-element.js.56edefc2.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/decorators/property.js.46436dfa.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/decorators/state.js.d7981ea7.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/decorators/event-options.js.c79389f6.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/decorators/query.js.122c484e.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/decorators/query-all.js.89bab0fa.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/decorators/query-async.js.1bb60a59.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/decorators/query-assigned-elements.js.2db6355b.js">
<link rel="modulepreload" href="./_npm/@lit/reactive-element@2.0.4/decorators/query-assigned-nodes.js.dc9eaf05.js">
<link rel="modulepreload" href="./_npm/@floating-ui/core@1.6.8/2d6722b1.js">
<link rel="modulepreload" href="./_npm/@floating-ui/utils@0.2.8/8e92bffe.js">
<link rel="modulepreload" href="./_npm/@floating-ui/utils@0.2.8/dom.c5d971f5.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directives/class-map.js.ac399c5b.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directive-helpers.js.3a6f7c92.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directives/if-defined.js.065d2226.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directives/live.js.8328442f.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directives/when.js.777bf979.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/static.js.03039b99.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directives/unsafe-html.js.ed6e7997.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directives/style-map.js.387bbac0.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directives/ref.js.72e3e53b.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directives/map.js.e28c73b2.js">
<link rel="modulepreload" href="./_npm/lit-html@3.2.1/directives/range.js.544168c4.js">
<link rel="icon" href="./_file/observable.1af93621.png" type="image/png" sizes="32x32">
<script type="module">

import {define} from "./_observablehq/client.1f32af9d.js";
import {registerFile} from "./_observablehq/stdlib.d4a7cb81.js";

registerFile("./assets/X-RISK-CC_Logo_Landscape_large.png", {"name":"./assets/X-RISK-CC_Logo_Landscape_large.png","mimeType":"image/png","path":"./_file/assets/X-RISK-CC_Logo_Landscape_large.a73a7cd9.png","lastModified":1748765280700,"size":64926});
registerFile("./data/data.csv", {"name":"./data/data.csv","mimeType":"text/csv","path":"./_file/data/data.a76977a8.csv","lastModified":1748764858287,"size":934302});

define({id: "e8d61a27", outputs: ["aq","setBasePath","showdown","H","ExcelJS"], body: async () => {
const [aq, {setBasePath}, {default: showdown}, {default: H}, {default: ExcelJS}] = await Promise.all([import("./_npm/arquero@7.2.0/f3eb4e3f.js"), import("./_npm/@shoelace-style/shoelace@2.19.0/41f6f18a.js"), import("./_npm/showdown@2.1.0/ed1696ce.js"), import("./_import/components/helpers.3bac2dd4.js"), import("./_npm/exceljs@4.4.0/222f7a0c.js")]);

// Set base path for assets
setBasePath("npm:@shoelace-style/shoelace/dist");


 // H for helper functions


return {aq,setBasePath,showdown,H,ExcelJS};
}});

define({id: "b4a7b048", inputs: ["Mutable"], outputs: ["is_newbie","unset_newbie","sector_labels"], body: (Mutable) => {
const is_newbie = Mutable(true)
const unset_newbie = () => is_newbie.value = false

//H.nodes_to_inputs('sl-button')

const sector_labels = {
    "natural hazard management": "Natural hazard management",
    "civil protection": "Civil protection",
    "spatial planning" : "Spatial Planning",
    "forest fires": "Forest fire management", 
    "protection forests" : "Protection forest management"
}
return {is_newbie,unset_newbie,sector_labels};
}});

define({id: "0fdd53a8", inputs: ["aq","FileAttachment","sector_labels"], outputs: ["data2","measure_count"], body: async (aq,FileAttachment,sector_labels) => {
const data2 = aq.from(await FileAttachment("./data/data.csv").csv())
// convert 0/1 in csv data to false/true
    .derive({
    "validated": aq.escape(d => d.validated == 1),
    "rating": 0,    
    "sector_order": aq.escape(
        d => ["natural hazard management", "civil protection",
            "spatial planning", "forest fires", "protection forests"
        ].indexOf(d.sector)
        ),
    "sector" : aq.escape(d => sector_labels[d.sector])
    })
    .orderby('sector_order')


const measure_count = 475 //data2.dedupe("id").array("id").length

return {data2,measure_count};
}});

define({id: "92de464d", inputs: ["H","data2"], outputs: ["data2_rolled_up"], body: (H,data2) => {
const data2_rolled_up = H.rollup_data(data2)
return {data2_rolled_up};
}});

define({id: "c40d74fd", inputs: ["_","data2","aq"], outputs: ["unique_entries"], body: (_,data2,aq) => {
// create collection of arquero tables, keyed by column name of data
// each arquero table has one column of unique values of the data column
// Example: unique_entries["sector"] has one column named "choices" containing
// all distinct values of data's column "sector"
const unique_entries = _.zipObject(
    data2.columnNames(),
    data2.columnNames().map(x => aq.table({"choices": _.uniq(data2.array(x))}))
)

return {unique_entries};
}});

define({id: "bd16f9ee", inputs: ["unique_entries","aq"], outputs: ["ordered_sectors","ordered_phases","ordered_ownerships","ordered_climaterisks"], body: (unique_entries,aq) => {

const ordered_sectors = [
"Natural Hazard Management", "Civil Protection", "Spatial Planning", "Protection Forest Management",
"Forest Fire Management"
]

const ordered_phases = [
    "Prevention: non-structural", "Prevention: structural",
	"Preparedness: tool implementation", "Preparedness: tools",
	"Response: tool implementation", "Response: tools",
  //  "Recovery: tool implementation",
	"Recovery: learning", "Recovery: structural",
    "Cross-cutting, generic"
]

const ordered_ownerships = [
    "transnational", 
    "national & subnational",
    "local & regional", 
    "private & individual (citizens, households, property owners)",
    "multi-level, cross-level, co-owned"    
]


const ordered_climaterisks = [
    "floods: riverine, fluvial", "flooding: pluvial", "hydrological hazards: other",
    "gravitational hazards: mass movements", 
    "forest disturbances & loss of protective forest functions",
    "forest fire, wildfire", "drought", "direct extreme weather impacts",
    "(peri-)glacial hazards", "multi-hazard, multi-risk"
]

unique_entries.phase = unique_entries.phase
    .derive({order: aq.escape(d => ordered_phases.indexOf(d.choices))})
    .orderby("order")

unique_entries.ownership = unique_entries.ownership
    .derive({order: aq.escape(d => ordered_ownerships.indexOf(d.choices))})
    .orderby("order")

unique_entries.climaterisk = unique_entries.risk
    .orderby("choices")

return {ordered_sectors,ordered_phases,ordered_ownerships,ordered_climaterisks};
}});

define({id: "520fafb2", inputs: ["unique_entries"], outputs: ["row_count"], body: (unique_entries) => {
const row_count = (colname) => {return unique_entries[colname].numRows()}
return {row_count};
}});

define({id: "7f9cddaf", inputs: ["H","data2","aq","selected_sectors","selected_phases","selected_gaps","selected_ownership_levels","selected_climaterisks","validated_only"], outputs: ["matches","match_count"], body: (H,data2,aq,selected_sectors,selected_phases,selected_gaps,selected_ownership_levels,selected_climaterisks,validated_only) => {
const matches = H.rollup_data(
    data2.filter(
        aq.escape(d => aq.op.indexof(selected_sectors.map(x => x.choices), d.sector) > -1 &
                  // aq.op.indexof(selected_clusters.map(x => x.choices), d.cluster) > -1 &
                  aq.op.indexof(selected_phases.map(x => x.choices), d.phase) > -1 &
                  aq.op.indexof(selected_gaps.map(x => x.choices), d.gap) > -1 &
                  aq.op.indexof(selected_ownership_levels.map(x => x.choices), d.ownership) > -1 &
                  aq.op.indexof(selected_climaterisks.map(x => x.choices), d.risk) > -1 &
                  // filter on "locally validation", depending on user's choice (switch)                  
                  aq.op.indexof([true, validated_only], d.validated) > -1 &
                  true
                  )
    )
)
.derive({no: aq.op.row_number() - 1})

const match_count = matches.numRows()

return {matches,match_count};
}});

define({id: "8f84fd78", inputs: ["localStorage","matches"], body: (localStorage,matches) => {
// save user defined matches and ratings to browser's local storage:
{localStorage.setItem("adaptation_measures", matches.toCSV())}
}});

define({id: "9da771cf", inputs: ["aq","localStorage"], outputs: ["storage_data"], body: (aq,localStorage) => {
// retrieve user defined matches (if necessary)
const storage_data = aq.fromCSV(localStorage.getItem("adaptation_measures"))
return {storage_data};
}});

define({id: "36ccc4e4", inputs: ["Mutable"], outputs: ["ratings","update_ratings","reset_ratings"], body: (Mutable) => {
const ratings = Mutable({})
const update_ratings = (entry) => {
    ratings.value = Object.assign({}, ratings.value, entry);
}
const reset_ratings = () => ratings.value = {}

return {ratings,update_ratings,reset_ratings};
}});

define({id: "320b11b7", inputs: ["matches","aq","ratings"], outputs: ["favorites"], body: (matches,aq,ratings) => {
const favorites = matches
    .derive({rating: aq.escape(d => ratings[d.id])})
    .filter(d => d.rating > 0)
return {favorites};
}});

define({id: "8f6dcbbc", outputs: ["refresh_views"], body: () => {
// things that should be triggered when "matches" (the filtered data)
// changes
const refresh_views = (matches) => {
    var badge = document.querySelector("#badge_matchcount")
    badge.setAttribute("pulse", "")
    setTimeout(() => badge.removeAttribute("pulse"), 1000)    
    return("")
    
    }    
return {refresh_views};
}});

define({id: "95cc96ea", mode: "inline", inputs: ["refresh_views","matches","display"], body: async (refresh_views,matches,display) => {
display(await(
refresh_views(matches)
))
}});

define({id: "f09d0bf3", mode: "inline", inputs: ["match_count","display"], body: async (match_count,display) => {
display(await(
match_count
))
}});

define({id: "9fb44b3b", inputs: ["H"], outputs: ["dummy"], body: (H) => {
let dummy = H.animate_badge()
return {dummy};
}});

define({id: "8923a462", mode: "inline", inputs: ["H","display"], body: async (H,display) => {
display(await(
H.button_show_dialog_filter()
))
}});

define({id: "8db1b76e", inputs: ["view","H"], outputs: ["reset_filters"], body: (view,H) => {
const reset_filters = view(H.get_reset_button_filters());
return {reset_filters};
}});

define({id: "4c919417", inputs: ["reset_filters","set_slide"], body: (reset_filters,set_slide) => {
// apart from resetting other views, do this whenever "reset filter" button is clicked:
{reset_filters; set_slide(1)}
}});

define({id: "17ffd657", mode: "inline", inputs: ["H","display"], body: async (H,display) => {
display(await(
H.get_dialog_filter()
))
}});

define({id: "5122b9c5", mode: "inline", inputs: ["selected_sectors","display"], body: async (selected_sectors,display) => {
display(await(
selected_sectors.length
))
}});

define({id: "47d51e96", mode: "inline", inputs: ["row_count","display"], body: async (row_count,display) => {
display(await(
row_count('sector')
))
}});

define({id: "3dac6e30", inputs: ["reset_filters","view","Inputs","unique_entries"], outputs: ["selected_sectors"], body: (reset_filters,view,Inputs,unique_entries) => {
    const selected_sectors = (reset_filters, view(Inputs.table(unique_entries.sector, 
    {required: true, header: {choices: "Policy sector"}}
    ))); 
return {selected_sectors};
}});

define({id: "1eff7e86", mode: "inline", inputs: ["selected_phases","display"], body: async (selected_phases,display) => {
display(await(
selected_phases.length
))
}});

define({id: "db5d0b76", mode: "inline", inputs: ["row_count","display"], body: async (row_count,display) => {
display(await(
row_count('phase')
))
}});

define({id: "0e7b4762", inputs: ["reset_filters","view","Inputs","unique_entries"], outputs: ["selected_phases"], body: (reset_filters,view,Inputs,unique_entries) => {
    const selected_phases = (reset_filters, view(Inputs.table(unique_entries.phase,
        {header: {choices: "Risk management cycle"}, columns: ["choices"]}
    )));  
return {selected_phases};
}});

define({id: "37167c3b", mode: "inline", inputs: ["selected_gaps","display"], body: async (selected_gaps,display) => {
display(await(
selected_gaps.length
))
}});

define({id: "d0dc22fa", mode: "inline", inputs: ["row_count","display"], body: async (row_count,display) => {
display(await(
row_count('gap')
))
}});

define({id: "584ee95e", inputs: ["reset_filters","view","Inputs","unique_entries"], outputs: ["selected_gaps"], body: (reset_filters,view,Inputs,unique_entries) => {
    const selected_gaps = (reset_filters, view(Inputs.table(unique_entries.gap,
        {header: {choices: "Gap types"}}
    )));
return {selected_gaps};
}});

define({id: "3390fb3e", mode: "inline", inputs: ["selected_ownership_levels","display"], body: async (selected_ownership_levels,display) => {
display(await(
selected_ownership_levels.length
))
}});

define({id: "a0574848", mode: "inline", inputs: ["ordered_ownerships","display"], body: async (ordered_ownerships,display) => {
display(await(
ordered_ownerships.length
))
}});

define({id: "d8e01871", inputs: ["reset_filters","view","Inputs","ordered_ownerships"], outputs: ["selected_ownership_levels"], body: (reset_filters,view,Inputs,ordered_ownerships) => {
    const selected_ownership_levels = (reset_filters, view(Inputs.table(
        ordered_ownerships.map(x => {return {"choices" : x}}),
        {header: {choices: "Risk ownership level"}, columns:["choices"]}
    ))); 
return {selected_ownership_levels};
}});

define({id: "2d85b8e2", mode: "inline", inputs: ["selected_climaterisks","display"], body: async (selected_climaterisks,display) => {
display(await(
selected_climaterisks.length
))
}});

define({id: "f3c694e1", mode: "inline", inputs: ["ordered_climaterisks","display"], body: async (ordered_climaterisks,display) => {
display(await(
ordered_climaterisks.length   
))
}});

define({id: "0a69ef92", inputs: ["reset_filters","view","Inputs","ordered_climaterisks"], outputs: ["selected_climaterisks"], body: (reset_filters,view,Inputs,ordered_climaterisks) => {
    const selected_climaterisks = (reset_filters, view(Inputs.table(
        ordered_climaterisks.map(x => {return {"choices" : x}}),
        {header: {choices: "Climate risk"}, columns:["choices"]}
    ))); 
return {selected_climaterisks};
}});

define({id: "a34d8387", inputs: ["reset_filters","view","Inputs"], outputs: ["validated_only"], body: (reset_filters,view,Inputs) => {
    const validated_only = (reset_filters, view(Inputs.toggle({label: "locally validated?", value: false})))
return {validated_only};
}});

define({id: "fe47f4cf", inputs: ["reset_filters","view","Inputs","html"], outputs: ["back"], body: (reset_filters,view,Inputs,html) => {
const back = (reset_filters, view(Inputs.button(html`<i class="fa fa-caret-left"/>`, {value: null})));
return {back};
}});

define({id: "b8a7e24e", mode: "inline", inputs: ["slide","display"], body: async (slide,display) => {
display(await(
slide
))
}});

define({id: "f09d0bf3-1", mode: "inline", inputs: ["match_count","display"], body: async (match_count,display) => {
display(await(
match_count
))
}});

define({id: "5a3cf462", inputs: ["reset_filters","view","Inputs","html"], outputs: ["forth"], body: (reset_filters,view,Inputs,html) => {
const forth = (reset_filters, view(Inputs.button(html`<i class="fa fa-caret-right"/>`, {value: null})));
return {forth};
}});

define({id: "453b3417", inputs: ["Mutable","match_count"], outputs: ["slide","set_slide","increase_slide","decrease_slide"], body: (Mutable,match_count) => {
// navigation through slides (measures):
const slide = Mutable(1);
const set_slide = (n) => slide.value = n
const increase_slide = (x) => slide.value < match_count ? slide.value += 1 : false
const decrease_slide = (x) => slide.value > 1 ? slide.value += -1 : false
return {slide,set_slide,increase_slide,decrease_slide};
}});

define({id: "651f5f07", inputs: ["increase_slide","forth"], body: (increase_slide,forth) => {
// increase slide number by clicking forward button
{increase_slide(forth)}
}});

define({id: "42271716", inputs: ["decrease_slide","back"], body: (decrease_slide,back) => {
// decrease slide number by clicking back button
{decrease_slide(back)}
}});

define({id: "3aa6ce6e", inputs: ["matches","slide"], outputs: ["cur_row"], body: (matches,slide) => {
// extract current row/slide from table "matches"
// (selected via pager, match list or favourites list)
const cur_row = matches.object(slide-1) 

return {cur_row};
}});

define({id: "682ae75e", mode: "inline", inputs: ["H","match_count","display"], body: async (H,match_count,display) => {
display(await(
H.get_newbie_info(match_count)
))
}});

define({id: "3481ff85", inputs: ["H","cur_row","update_ratings"], outputs: ["the_rater"], body: (H,cur_row,update_ratings) => {
const the_rater = H.get_rater(cur_row)
// update ratings for the displayed slide
the_rater.addEventListener("sl-change", (e) => {
    update_ratings({[e.target.id]: e.target.value});
    return false;    
    });
return {the_rater};
}});

define({id: "49eacbb2", mode: "inline", inputs: ["the_rater","display"], body: async (the_rater,display) => {
display(await(
the_rater
))
}});

define({id: "a1e5153e", mode: "inline", inputs: ["H","cur_row","display"], body: async (H,cur_row,display) => {
display(await(
H.get_detail(cur_row)
))
}});

define({id: "c96962a1", inputs: ["ratings"], body: (ratings) => {
{
let any_favs = Object.keys(ratings).length
document.querySelector("#no_favs").style.display = any_favs ? "none" : "block"
document.querySelector("#table_favorites").style.display = any_favs ? "block" : "none"
}
}});

define({id: "1b82431a", inputs: ["view","Inputs","html"], outputs: ["reset_ratings_clicked"], body: (view,Inputs,html) => {
const reset_ratings_clicked = view(Inputs.button(html`<span class="fas fa-slash" data-fa-mask="fas fa-star" data-fa-transform="up-2.5"></span> clear favourites`))
return {reset_ratings_clicked};
}});

define({id: "90f4bcdc", inputs: ["reset_filters","view","H","matches","ratings"], outputs: ["selected_favorite"], body: (reset_filters,view,H,matches,ratings) => {
const selected_favorite = (reset_filters, view(H.get_table_favs(matches, ratings)))
return {selected_favorite};
}});

define({id: "6c5a44c3", inputs: ["selected_favorite","set_slide"], body: (selected_favorite,set_slide) => {
// set slide number by selecting from the list of favourites:
{selected_favorite && set_slide(selected_favorite.no)}
}});

define({id: "22e2afed", inputs: ["reset_ratings_clicked","reset_ratings"], body: (reset_ratings_clicked,reset_ratings) => {
{reset_ratings_clicked && reset_ratings()}
}});

define({id: "f57f0aeb", inputs: ["reset_filters","view","Inputs","matches","html"], outputs: ["selected_match"], body: (reset_filters,view,Inputs,matches,html) => {
const selected_match = (reset_filters, view(Inputs.table(matches,
{columns: ["id", "measure"], header: {id: "#", rating: "stars"},
select: true, multiple: false, width: {no: "2em"},
format: {measure: d => html`<span style="">${d}</span`},
width: {id: "4em"},
header:{measure: "gap"}
}
)))
return {selected_match};
}});

define({id: "4d30b7fb", inputs: ["selected_match","set_slide"], body: (selected_match,set_slide) => {
// set slide number by selecting from the list of matches:
{selected_match && set_slide(selected_match.no)}
}});

define({id: "34da93e2", inputs: ["FileAttachment"], outputs: ["img_src"], body: async (FileAttachment) => {
const img_src = await FileAttachment("./assets/X-RISK-CC_Logo_Landscape_large.png").arrayBuffer()
return {img_src};
}});

define({id: "680e2c2a", inputs: ["ExcelJS","img_src","matches"], outputs: ["wb","ws_readme","ws","header_logo","xl_blob","obj_url"], body: async (ExcelJS,img_src,matches) => {
const wb = new ExcelJS.Workbook();
const ws_readme = wb.addWorksheet('README');
const ws = wb.addWorksheet('Results');
const header_logo = wb.addImage({buffer: img_src, extension: 'png'});

ws.columns = [
  { header: 'Id', key: 'id', width: 5},
  { header: 'Rating', key: 'rating', width: 5 },
  { header: 'Topic', key: 'cluster', width: 16 },
  { header: 'Sector', key: 'sector', width: 16 },
  { header: 'Phases', key: 'phases', width: 16 },
  { header: 'Gap', key: 'measure', width: 50 },
  { header: 'Risk ownership level', key: 'ownerships', width: 16 },
  { header: 'Risk(s) related to', key: 'climaterisks', width: 32 },
  { header: 'Locally validated', key: 'validated', width: 4 }
];


ws.autoFilter = 'A1:I1';

// (re)set col widths for results:
Object.entries({A: 5, B: 5, C: 20, D: 20, E: 20, 
                F: 40, G: 20, H: 20, I: 10
                })
    .forEach(k => ws.getColumn(k[0]).width = k[1])


ws_readme.addImage(header_logo, {
  tl: { col: 0, row: 0 },
  ext: { width: 600, height: 600/5.464348}
});

ws_readme.getCell('A10').value = "generated on:"
ws_readme.getCell('B10').value = new Date()

// set col widths for README:
Object.entries({A: 20, B: 20})
    .forEach(k => ws_readme.getColumn(k[0]).width = k[1])

// ws_readme.getColumn(2).width = 20

ws.addRows(matches
// .groupby('id')
// .rollup({ phases: d => d.phases})
.objects()
)

ws.views = [
  {state: 'frozen', xSplit: 2, ySplit: 1}
];

const xl_blob = new Blob([await wb.xlsx.writeBuffer()], {type: '.xlsx'})
const obj_url = URL.createObjectURL(xl_blob);

return {wb,ws_readme,ws,header_logo,xl_blob,obj_url};
}});

define({id: "f46cda3c", mode: "inline", inputs: ["display","html","obj_url"], body: (display,html,obj_url) => {
display(html`<sl-button aria-label="download suggestions" size="large" href="${obj_url}" 
        download="X-RISK-CC_policy-gaps-results.xlsx"
         circle><i class="fa fa-download"></i></sl-button>`)
}});

</script>
</head>
<body>
<div id="observablehq-center">
<main id="observablehq-main" class="observablehq">
<link rel="stylesheet" href="./_file/custom.ae6710e3.css">
<link rel="stylesheet" href="./_file/assets/shoelace-light.48932bd1.css">
    <script defer="" src="./_import/assets/fontawesome/fontawesome.565e2865.js"></script>
<script defer="" src="./_import/assets/fontawesome/solid.a24bd8d2.js"></script>
<div class="observablehq observablehq--block"><!--:e8d61a27:--></div>
<div class="observablehq observablehq--block"><!--:b4a7b048:--></div>
<div class="observablehq observablehq--block"><!--:0fdd53a8:--></div>
<div class="observablehq observablehq--block"><!--:92de464d:--></div>
<div class="grid grid-cols-4" style="width:90%; font-family:sans; align-items:start">
  <div class="grid-colspan-2"><h1>Mind the gap!</h1>
   <h2>the X-RISK-CC policy gap explorer</h2>
  </div>
  <div style="text-align:right"><h1 style="align:middle">X-Risk-CC</h1></div>
  <div style="text-align:right"><img src="./_file/assets/X-RISK-CC_Logo_Landscape_large.a73a7cd9.png" width="300"></div>
</div>
<div class="observablehq observablehq--block"><!--:c40d74fd:--></div>
<div class="observablehq observablehq--block"><!--:bd16f9ee:--></div>
<div class="observablehq observablehq--block"><!--:520fafb2:--></div>
<div class="observablehq observablehq--block"><!--:7f9cddaf:--></div>
<div class="observablehq observablehq--block"><!--:8f84fd78:--></div>
<div class="observablehq observablehq--block"><!--:9da771cf:--></div>
<div class="observablehq observablehq--block"><!--:36ccc4e4:--></div>
<div class="observablehq observablehq--block"><!--:320b11b7:--></div>
<div class="observablehq observablehq--block"><!--:8f6dcbbc:--></div>
<!-- doesn't display anything but listens to changes in "matches",
e. g. to add and remove pulsating css to badges
-->
<p><span><observablehq-loading></observablehq-loading><!--:95cc96ea:--></span></p>
<div style="display:grid;
    grid-template-columns: 20% 50% 20%;
    gap:1em;">
    <div><!-- first row, left column --></div>
    <!-- center column: -->
    <div>
</div>
<div></div><!-- first row, right column -->
<div><!-- second row, left column: -->
<div id="badge_container">
<sl-badge id="badge_matchcount" variant="success" pill="" style="font-size:larger"><observablehq-loading></observablehq-loading><!--:f09d0bf3:--></sl-badge> matches
</div>
<div class="observablehq observablehq--block"><!--:9fb44b3b:--></div>
<div class="card">
<div style="display:grid; grid-template-columns:90% 10%; justify-content: space-between;">
Narrow your search with the filters below.
<observablehq-loading></observablehq-loading><!--:8923a462:-->
</div>
<div style="display:grid; grid-template-columns:50% 50%;">
<div>
<div class="observablehq observablehq--block"><!--:8db1b76e:--></div>
<div class="observablehq observablehq--block"><!--:4c919417:--></div>
</div>
<div>
<observablehq-loading></observablehq-loading><!--:17ffd657:-->
</div>
</div>
<sl-details>
    <div slot="summary">Policy sector (<observablehq-loading></observablehq-loading><!--:5122b9c5:--> / <observablehq-loading></observablehq-loading><!--:47d51e96:-->)</div>
<div class="observablehq observablehq--block"><!--:3dac6e30:--></div>
</sl-details>
<sl-details>
    <div slot="summary">Risk management cycle (<observablehq-loading></observablehq-loading><!--:1eff7e86:--> / <observablehq-loading></observablehq-loading><!--:db5d0b76:-->)</div>
        <div class="grid-cols-2">
<div class="observablehq observablehq--block"><!--:0e7b4762:--></div>
</div>
</sl-details>
<sl-details>
    <div slot="summary">Gap types (<observablehq-loading></observablehq-loading><!--:37167c3b:--> / <observablehq-loading></observablehq-loading><!--:d0dc22fa:-->)</div>   
<div class="observablehq observablehq--block"><!--:584ee95e:--></div>
</sl-details>
<sl-details>
    <div slot="summary">Risk ownership level
     (<observablehq-loading></observablehq-loading><!--:3390fb3e:--> / <observablehq-loading></observablehq-loading><!--:a0574848:-->)
     </div>   
<div class="observablehq observablehq--block"><!--:d8e01871:--></div>
</sl-details>
<sl-details>
    <div slot="summary">Risks related to
     (<observablehq-loading></observablehq-loading><!--:2d85b8e2:--> / <observablehq-loading></observablehq-loading><!--:f3c694e1:-->)
     </div>   
<div class="observablehq observablehq--block"><!--:0a69ef92:--></div>
</sl-details>
<sl-details>
    <div slot="summary">Local validation</div>
<div class="observablehq observablehq--block"><!--:a34d8387:--></div>
</sl-details>
</div> <!-- end of left filter card -->
</div>
<div><!-- center column -->
<div class="navigate_measures">
    <div>
<div class="observablehq observablehq--block"><!--:fe47f4cf:--></div>
</div>
<div>
<observablehq-loading></observablehq-loading><!--:b8a7e24e:--> / <observablehq-loading></observablehq-loading><!--:f09d0bf3-1:-->
<!--
    <sl-alert id="no_filters" open closable class="alert-closable">
    <sl-icon slot="icon" name="info-circle"></sl-icon>
    Currently, all ${match_count} available measures will be displayed.<br>You can use the filter menu (left) to narrow down your selection.

```js
// hide the "use filters" alert if appropriate:
{match_count < measure_count && document.querySelector("#no_filters").removeAttribute("open")}

```
-->
</div>
<div>
<div class="observablehq observablehq--block"><!--:5a3cf462:--></div>
</div>
<!-- code for navigation through slides -->
<div class="observablehq observablehq--block"><!--:453b3417:--></div>
<div class="observablehq observablehq--block"><!--:651f5f07:--></div>
<div class="observablehq observablehq--block"><!--:42271716:--></div>
<!-- end code for navigation through slides -->
<div class="observablehq observablehq--block"><!--:3aa6ce6e:--></div>
</div>
<!--navigate_measures-->
<div id="newbie-info"><observablehq-loading></observablehq-loading><!--:682ae75e:--></div>
<div class="container-description">
<div class="observablehq observablehq--block"><!--:3481ff85:--></div>
<sl-card class="card_measure">
    <div slot="header"><div></div><observablehq-loading></observablehq-loading><!--:49eacbb2:--></div><observablehq-loading></observablehq-loading><!--:a1e5153e:-->
</sl-card>
</div>
</div><!-- end of center column -->
<!-- right column: -->
<div>
<p><strong>Favourites</strong></p>
<div class="observablehq observablehq--block"><!--:c96962a1:--></div>
<p><sl-alert id="no_favs" open="">No favourites selected yet. You can add favourites with the rating widget:
<sl-rating max="3" style="--symbol-size: 1rem;" disabled=""></sl-rating>
</sl-alert></p>
<div id="table_favorites">
<div class="observablehq observablehq--block"><!--:1b82431a:--></div>
<div class="observablehq observablehq--block"><!--:90f4bcdc:--></div>
</div>
<div class="observablehq observablehq--block"><!--:6c5a44c3:--></div>
<div class="observablehq observablehq--block"><!--:22e2afed:--></div>
<p><strong>Matches</strong></p>
<div class="observablehq observablehq--block"><!--:f57f0aeb:--></div>
<div class="observablehq observablehq--block"><!--:4d30b7fb:--></div>
<div class="observablehq observablehq--block"><!--:34da93e2:--></div>
<div class="observablehq observablehq--block"><!--:680e2c2a:--></div>
<div class="">
    <strong>Download matches:</strong>
    <div style="text-align:center">
        <observablehq-loading></observablehq-loading><!--:f46cda3c:-->
    </div>
</div>
</div>
</div>
</main>
<footer id="observablehq-footer">
<div>Built with Observable</div>
</footer>
</div>
</body>
</html>
